# ğŸ”¥ High-Traffic Lab â€” ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œ

> 500ëª…ì´ ë™ì‹œì— 100ê°œì˜ ì¿ í°ì„ ìš”ì²­í•˜ë©´, ì •í™•íˆ 100ëª…ë§Œ ë°œê¸‰ë°›ì•„ì•¼ í•œë‹¤.

ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ í™˜ê²½ì—ì„œ **ë™ì‹œì„± ì œì–´**ë¥¼ ë‹¨ê³„ë³„ë¡œ ë°œì „ì‹œí‚¤ë©°, ê° ë°©ì‹ì˜ í•œê³„ë¥¼ ì§ì ‘ ì²´ê°í•˜ê³  í•´ê²°í•´ë‚˜ê°„ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

ë‹¨ìˆœíˆ "Redisë¥¼ ì¼ë‹¤", "Kafkaë¥¼ ë„ì…í–ˆë‹¤"ê°€ ì•„ë‹ˆë¼, **ì™œ ê¸°ì¡´ ë°©ì‹ì´ í•œê³„ì— ë¶€ë”ªí˜”ëŠ”ì§€ë¥¼ ë¨¼ì € ê²½í—˜í•œ ë’¤** ë‹¤ìŒ ê¸°ìˆ ì„ ë„ì…í•˜ëŠ” ê³¼ì •ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.

<br>

## ê¸°ìˆ  ìŠ¤íƒ

| ë¶„ë¥˜ | ê¸°ìˆ  |
|:---|:---|
| Language | Java 17 |
| Framework | Spring Boot 3.x |
| Database | MySQL 8.0, Flyway |
| Cache | Redis (Lua Script) |
| Message Queue | Apache Kafka (Confluent 7.5.0) |
| Infra | Docker, Docker Compose |
| Test | k6 (ë¶€í•˜ í…ŒìŠ¤íŠ¸) |

<br>

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client (k6)                              â”‚
â”‚                      500ëª… ë™ì‹œ ìš”ì²­                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ POST /api/v1/coupons/issue
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Spring Boot Application                      â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CouponIssueService                                      â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚  1. íšŒì› ê²€ì¦ (DB)                                       â”‚     â”‚
â”‚  â”‚  2. ì¬ê³  ì°¨ê° + ì¤‘ë³µ ì²´í¬ (Redis Lua Script) â—„â”€â”€ ì›ìì   â”‚     â”‚
â”‚  â”‚  3. Kafka ì´ë²¤íŠ¸ ë°œí–‰                                    â”‚     â”‚
â”‚  â”‚  4. ì¦‰ì‹œ ì‘ë‹µ ë°˜í™˜                                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ CouponIssueConsumer (Kafka)                             â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚  - ë©±ë“±ì„± ì²´í¬ í›„ DB ì €ì¥                                â”‚     â”‚
â”‚  â”‚  - ì‹¤íŒ¨ ì‹œ 3íšŒ ì¬ì‹œë„ â†’ DLQ ì´ë™                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                       â”‚ ì‹¤íŒ¨ ì‹œ                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ DLQ Consumer â†’ DLQ Processor                            â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚  - @Retryable (3íšŒ, Exponential Backoff)                â”‚     â”‚
â”‚  â”‚  - ìµœì¢… ì‹¤íŒ¨ ì‹œ: Redis ë¡¤ë°± + failed_coupon_issues ì €ì¥  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Reconciliation Scheduler (5ë¶„ ì£¼ê¸°)                      â”‚     â”‚
â”‚  â”‚                                                         â”‚     â”‚
â”‚  â”‚  - Redis â†” DB ì •í•©ì„± ê²€ì¦                                â”‚     â”‚
â”‚  â”‚  - ë¶ˆì¼ì¹˜ ê±´ ìë™ ë³µêµ¬ (Redis ë¡¤ë°± + ì‹¤íŒ¨ ê¸°ë¡)           â”‚     â”‚
â”‚  â”‚  - ë°œê¸‰ ìˆ˜ëŸ‰ ë™ê¸°í™”                                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  MySQL   â”‚        â”‚  Redis   â”‚        â”‚  Kafka   â”‚
   â”‚          â”‚        â”‚          â”‚        â”‚          â”‚
   â”‚ members  â”‚        â”‚ stock:   â”‚        â”‚ coupon-  â”‚
   â”‚ coupons  â”‚        â”‚  FLASH100â”‚        â”‚  issued  â”‚
   â”‚ coupon_  â”‚        â”‚ issued:  â”‚        â”‚ coupon-  â”‚
   â”‚  issues  â”‚        â”‚  FLASH100â”‚        â”‚  issued  â”‚
   â”‚ failed_  â”‚        â”‚          â”‚        â”‚  .DLQ    â”‚
   â”‚  coupon_ â”‚        â”‚          â”‚        â”‚          â”‚
   â”‚  issues  â”‚        â”‚          â”‚        â”‚          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<br>

## Phaseë³„ ì§„í–‰ ê³¼ì •

ì´ í”„ë¡œì íŠ¸ì˜ í•µì‹¬ì€ **"ë¬¸ì œë¥¼ ë¨¼ì € ì²´ê°í•˜ê³ , ê·¸ ë‹¤ìŒ í•´ê²°í•œë‹¤"** ëŠ” ì ‘ê·¼ ë°©ì‹ì…ë‹ˆë‹¤.

### Phase 1~2: DB ë ˆë²¨ ë™ì‹œì„± ì œì–´

**ë‚™ê´€ì  ë½ (`@Version`)** ìœ¼ë¡œ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. 500ëª… ë™ì‹œ ìš”ì²­ ì‹œ `OptimisticLockException`ì´ ëŒ€ëŸ‰ ë°œìƒí•˜ë©°, ì¬ì‹œë„ ì—†ì´ëŠ” ì •ìƒ ë°œê¸‰ì´ ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. ë¹„ê´€ì  ë½ (`SELECT ... FOR UPDATE`)ìœ¼ë¡œ ì „í™˜í•˜ë©´ ì •í•©ì„±ì€ ë³´ì¥ë˜ì§€ë§Œ, DB ë ˆë²¨ ë½ìœ¼ë¡œ ì¸í•´ ì²˜ë¦¬ëŸ‰ì´ ê¸‰ê²©íˆ ë–¨ì–´ì§€ëŠ” ë³‘ëª©ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**í•œê³„**: DBì—ì„œ ë™ì‹œì„±ì„ ì œì–´í•˜ëŠ” ê²ƒ ìì²´ê°€ í™•ì¥ì„±ì˜ í•œê³„.

### Phase 3: Redis ë¶„ì‚° ë½

Redissonì˜ ë¶„ì‚° ë½ì„ ë„ì…í•˜ì—¬ DB ë¶€ë‹´ì„ ì¤„ì˜€ì§€ë§Œ, ë½ íšë“ ëŒ€ê¸° ì‹œê°„ê³¼ íƒ€ì„ì•„ì›ƒ ì„¤ì •ì´ ê¹Œë‹¤ë¡œì› ê³ , ë½ ìì²´ê°€ ì§ë ¬ ì²˜ë¦¬ êµ¬ê°„ì„ ë§Œë“¤ì–´ ì²˜ë¦¬ëŸ‰ì— í•œê³„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

**í•œê³„**: ë½ = ì§ë ¬í™”. íŠ¸ë˜í”½ì´ ë§ì•„ì§ˆìˆ˜ë¡ ëŒ€ê¸°ì—´ì´ ê¸¸ì–´ì§.

### Phase 4: Redis DECR + Kafka ë¹„ë™ê¸° ì²˜ë¦¬

ë½ì„ ì•„ì˜ˆ ì œê±°í•˜ê³ , Redis `DECR` ì›ìì  ì—°ì‚°ìœ¼ë¡œ ì¬ê³ ë¥¼ ì°¨ê°í•œ ë’¤ Kafkaë¡œ í›„ì²˜ë¦¬ë¥¼ ìœ„ì„í•˜ëŠ” êµ¬ì¡°ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤. ì´ë¡œì¨ ì‘ë‹µ ì†ë„ê°€ í¬ê²Œ ê°œì„ ë˜ì—ˆì§€ë§Œ, `DECR`ê³¼ ì¤‘ë³µ ì²´í¬(`SISMEMBER`)ê°€ ë³„ë„ ëª…ë ¹ì´ë¼ ë‘ ì—°ì‚° ì‚¬ì´ì— Race Conditionì´ ë°œìƒí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

**í•œê³„**: ë‘ ê°œì˜ Redis ëª…ë ¹ ì‚¬ì´ í‹ˆìƒˆì—ì„œ ë™ì‹œì„± ì´ìŠˆ ë°œìƒ ê°€ëŠ¥.

### Phase 5: Lua Script ì›ìì  ì—°ì‚°

ì¤‘ë³µ ì²´í¬(`SADD`) + ì¬ê³  í™•ì¸(`GET`) + ì¬ê³  ì°¨ê°(`DECR`)ì„ í•˜ë‚˜ì˜ Lua ìŠ¤í¬ë¦½íŠ¸ë¡œ ë¬¶ì–´ ì›ìì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤. RedisëŠ” Lua ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ì‹¤í–‰í•˜ë¯€ë¡œ Race Conditionì´ ì›ì²œ ì°¨ë‹¨ë©ë‹ˆë‹¤.

```lua
-- 1. ì¤‘ë³µ ì²´í¬ (SADD: ì´ë¯¸ ìˆìœ¼ë©´ 0 ë°˜í™˜)
local added = redis.call('SADD', KEYS[2], ARGV[1])
if added == 0 then return -3 end

-- 2. ì¬ê³  í™•ì¸
local stock = redis.call('GET', KEYS[1])
if not stock then
    redis.call('SREM', KEYS[2], ARGV[1])
    return -1
end

-- 3. ì¬ê³  ìˆ˜ëŸ‰ ê²€ì¦
if tonumber(stock) <= 0 then
    redis.call('SREM', KEYS[2], ARGV[1])
    return -2
end

-- 4. ì¬ê³  ì°¨ê°
return redis.call('DECR', KEYS[1])
```

### Phase 6~7: ì¥ì•  ë³µêµ¬ ì²´ê³„ (ì´ì¤‘ ì•ˆì „ë§)

Kafka Consumer ì‹¤íŒ¨ì— ëŒ€ë¹„í•œ 3ë‹¨ê³„ ë³µêµ¬ ì²´ê³„ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.

| ë‹¨ê³„ | ì²˜ë¦¬ | ì„¤ëª… |
|:---|:---|:---|
| 1ì°¨ | `whenComplete()` ì½œë°± | Kafka ë°œí–‰ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ Redis ë¡¤ë°± |
| 2ì°¨ | DLQ + `@Retryable` | Consumer ì‹¤íŒ¨ â†’ DLQ ì´ë™ â†’ 3íšŒ ì¬ì‹œë„ (Exponential Backoff) |
| 3ì°¨ | Reconciliation Batch | 5ë¶„ ì£¼ê¸°ë¡œ Redis â†” DB ì •í•©ì„± ê²€ì¦, ë¶ˆì¼ì¹˜ ê±´ ìë™ ë³µêµ¬ |

### Phase 8: Kafka íŒŒí‹°ì…˜ ìŠ¤ì¼€ì¼ë§

ë‹¨ì¼ íŒŒí‹°ì…˜ì—ì„œ 3ê°œ íŒŒí‹°ì…˜ìœ¼ë¡œ í™•ì¥í•˜ê³ , Consumer `concurrency`ë¥¼ 3ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë³‘ë ¬ ì†Œë¹„ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

```java
// KafkaConfig.java
@Bean
public NewTopic couponIssuedTopic() {
    return TopicBuilder.name("coupon-issued")
            .partitions(3)
            .replicas(1)
            .build();
}
```

<br>

## í•µì‹¬ ì„¤ê³„ ê²°ì •

### Transactional Outbox Patternì„ ì ìš©í•˜ì§€ ì•Šì€ ì´ìœ 

Outbox íŒ¨í„´ì€ "DB íŠ¸ëœì­ì…˜ê³¼ ë©”ì‹œì§€ ë°œí–‰ì˜ ì›ìì„±"ì„ ë³´ì¥í•˜ëŠ” íŒ¨í„´ì´ì§€ë§Œ, ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì¬ê³  íŒì •ì˜ ì›ì²œì´ Redisì´ê³  DBëŠ” í›„ì²˜ë¦¬ ì €ì¥ì†Œ ì—­í• ì´ë¯€ë¡œ Outboxì˜ ì „ì œ ì¡°ê±´("DBì— ë¨¼ì € ì“°ê³ , ê·¸ ì‚¬ì‹¤ì„ ë©”ì‹œì§€ë¡œ ì „íŒŒ")ê³¼ ë§ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëŒ€ì‹  Kafka ë°œí–‰ ì‹¤íŒ¨ ì‹œ Redis ë¡¤ë°± + DLQ + Reconciliationìœ¼ë¡œ ì •í•©ì„±ì„ ë³´ì¥í•˜ëŠ” ë°©ì‹ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

### ë©±ë“±ì„± ë³´ì¥ ì „ëµ

Kafka Consumerì—ì„œ ì¤‘ë³µ ë©”ì‹œì§€ ì²˜ë¦¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë‘ ê°€ì§€ ë°©ì–´ì„ ì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤. ë¨¼ì € `couponIssueRepository.existsByCouponIdAndMemberId()`ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì²´í¬ë¥¼ ìˆ˜í–‰í•˜ê³ , DBì˜ `UNIQUE(coupon_id, member_id)` ì œì•½ ì¡°ê±´ìœ¼ë¡œ `DataIntegrityViolationException`ì„ catchí•˜ì—¬ ìµœì¢… ë°©ì–´í•©ë‹ˆë‹¤.

<br>

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
src/main/java/com/portfolio/hightrafficlab/
â”œâ”€â”€ application/coupon/
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ CouponIssueResponse.java      # ë°œê¸‰ ì‘ë‹µ DTO
â”‚   â”‚   â”œâ”€â”€ CouponIssuedEvent.java        # Kafka ì´ë²¤íŠ¸
â”‚   â”‚   â”œâ”€â”€ StockDecreaseResult.java      # Redis ì¬ê³  ì°¨ê° ê²°ê³¼
â”‚   â”‚   â””â”€â”€ ReconciliationResult.java     # ì •í•©ì„± ê²€ì¦ ê²°ê³¼
â”‚   â”œâ”€â”€ scheduler/
â”‚   â”‚   â””â”€â”€ ReconciliationScheduler.java  # 5ë¶„ ì£¼ê¸° ì •í•©ì„± ê²€ì¦
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ CouponIssueService.java       # ì¿ í° ë°œê¸‰ (Redis + Kafka)
â”‚       â”œâ”€â”€ CouponStockService.java       # Redis ì¬ê³  ê´€ë¦¬ (Lua Script)
â”‚       â”œâ”€â”€ CouponIssueConsumer.java      # Kafka Consumer
â”‚       â”œâ”€â”€ CouponIssueDlqConsumer.java   # DLQ Consumer
â”‚       â”œâ”€â”€ CouponIssueDlqProcessor.java  # DLQ ì¬ì‹œë„ + ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬
â”‚       â””â”€â”€ ReconciliationService.java    # Redis â†” DB ì •í•©ì„± ê²€ì¦/ë³µêµ¬
â”‚
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ exception/
â”‚   â”‚   â”œâ”€â”€ ErrorCode.java                # ì—ëŸ¬ ì½”ë“œ ì •ì˜
â”‚   â”‚   â””â”€â”€ BusinessException.java        # ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸
â”‚   â””â”€â”€ response/
â”‚       â””â”€â”€ ApiResponse.java              # ê³µí†µ API ì‘ë‹µ í¬ë§·
â”‚
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ coupon/
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”œâ”€â”€ Coupon.java               # ì¿ í° (ë‚™ê´€ì  ë½ @Version)
â”‚   â”‚   â”‚   â”œâ”€â”€ CouponIssue.java          # ì¿ í° ë°œê¸‰ ì´ë ¥
â”‚   â”‚   â”‚   â”œâ”€â”€ CouponStatus.java
â”‚   â”‚   â”‚   â”œâ”€â”€ IssueStatus.java
â”‚   â”‚   â”‚   â”œâ”€â”€ FailedCouponIssue.java    # DLQ ìµœì¢… ì‹¤íŒ¨ ê¸°ë¡
â”‚   â”‚   â”‚   â””â”€â”€ FailedStatus.java
â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚       â”œâ”€â”€ CouponRepository.java
â”‚   â”‚       â”œâ”€â”€ CouponIssueRepository.java
â”‚   â”‚       â””â”€â”€ FailedCouponIssueRepository.java
â”‚   â””â”€â”€ member/
â”‚       â”œâ”€â”€ entity/
â”‚       â”‚   â”œâ”€â”€ Member.java
â”‚       â”‚   â””â”€â”€ MemberStatus.java
â”‚       â””â”€â”€ repository/
â”‚           â””â”€â”€ MemberRepository.java
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ JpaConfig.java
â”‚   â”‚   â”œâ”€â”€ KafkaConfig.java              # Producer, Consumer, DLQ, ErrorHandler
â”‚   â”‚   â””â”€â”€ RedisScriptConfig.java        # Lua Script ë¡œë”©
â”‚   â”œâ”€â”€ exception/
â”‚   â”‚   â””â”€â”€ GlobalExceptionHandler.java
â”‚   â””â”€â”€ support/
â”‚       â””â”€â”€ DatabaseCleaner.java          # í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™” (local only)
â”‚
â””â”€â”€ presentation/
    â”œâ”€â”€ coupon/
    â”‚   â”œâ”€â”€ controller/
    â”‚   â”‚   â”œâ”€â”€ CouponIssueController.java    # ì¿ í° ë°œê¸‰ API
    â”‚   â”‚   â””â”€â”€ CouponStockController.java    # ì¬ê³  ê´€ë¦¬ API (local only)
    â”‚   â””â”€â”€ request/
    â”‚       â””â”€â”€ CouponIssueRequest.java
    â””â”€â”€ dataReset/
        â””â”€â”€ DatabaseCleanerController.java    # DB ì´ˆê¸°í™” API (local only)

src/main/resources/
â”œâ”€â”€ application.yml             # ê³µí†µ ì„¤ì • (Flyway, JPA, Tomcat)
â”œâ”€â”€ application-local.yml       # ë¡œì»¬ í™˜ê²½ (localhost DB, Redis, Kafka)
â”œâ”€â”€ application-prod.yml        # ìš´ì˜ í™˜ê²½ (Docker ë‚´ë¶€ í†µì‹ )
â”œâ”€â”€ db/migration/
â”‚   â”œâ”€â”€ V1__dataInit.sql        # í…Œì´ë¸” ìƒì„± + í…ŒìŠ¤íŠ¸ ë°ì´í„° (íšŒì› 500ëª…, ì¿ í° 3ì¢…)
â”‚   â””â”€â”€ V2__failTableInit.sql   # DLQ ì‹¤íŒ¨ ê¸°ë¡ í…Œì´ë¸”
â””â”€â”€ redis/scripts/
    â””â”€â”€ decrease_stock.lua      # ì¬ê³  ì°¨ê° Lua ìŠ¤í¬ë¦½íŠ¸
```

<br>

## ì‹¤í–‰ ë°©ë²•

### ì‚¬ì „ ì¤€ë¹„

- Docker & Docker Compose
- Java 17
- Gradle

### 1. ì¸í”„ë¼ êµ¬ì„± (Docker)

```bash
# í”„ë¡œì íŠ¸ í´ë¡ 
git clone https://github.com/your-repo/high-traffic-lab.git
cd high-traffic-lab

# ì¸í”„ë¼ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (MySQL, Redis, Kafka, Zookeeper)
docker-compose up db-local redis zookeeper kafka -d

# ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
docker ps
```

`.env` íŒŒì¼ì— í™˜ê²½ ë³€ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

| ë³€ìˆ˜ | ê¸°ë³¸ê°’ | ì„¤ëª… |
|:---|:---|:---|
| `DB_LOCAL_NAME` | `htl_local` | ë¡œì»¬ DB ì´ë¦„ |
| `DB_LOCAL_USER` | `htl_local_user` | ë¡œì»¬ DB ì‚¬ìš©ì |
| `DB_LOCAL_PASSWORD` | `htl_local_pw` | ë¡œì»¬ DB ë¹„ë°€ë²ˆí˜¸ |
| `SPRING_PROFILES_ACTIVE` | `local` | í™œì„± í”„ë¡œí•„ |

### 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

```bash
# Gradle ë¹Œë“œ & ì‹¤í–‰ (local í”„ë¡œí•„)
./gradlew bootRun
```

ì•±ì´ ì‹œì‘ë˜ë©´ Flywayê°€ ìë™ìœ¼ë¡œ í…Œì´ë¸” ìƒì„± + í…ŒìŠ¤íŠ¸ ë°ì´í„°(íšŒì› 500ëª…, ì¿ í° 3ì¢…)ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.

### 3. ë™ì‘ í™•ì¸

```bash
# Redis ì¬ê³  ì´ˆê¸°í™” (FLASH100 ì¿ í° 100ê°œ)
curl -X POST "http://localhost:8080/api/v1/coupons/stock/init?couponCode=FLASH100&quantity=100"

# í˜„ì¬ ì¬ê³  í™•ì¸
curl http://localhost:8080/api/v1/coupons/stock/FLASH100

# ì¿ í° ë°œê¸‰ í…ŒìŠ¤íŠ¸ (ë‹¨ê±´)
curl -X POST http://localhost:8080/api/v1/coupons/issue \
  -H "Content-Type: application/json" \
  -d '{"couponCode": "FLASH100", "memberId": 1}'
```

<br>

## ë¶€í•˜ í…ŒìŠ¤íŠ¸

### ì‚¬ì „ ì¤€ë¹„

[k6](https://k6.io/) ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

500ëª…ì˜ ì‚¬ìš©ìê°€ ë™ì‹œì— 100ê°œ í•œì • ì¿ í°ì„ ìš”ì²­í•©ë‹ˆë‹¤. ì •í™•íˆ 100ëª…ë§Œ ì„±ê³µí•˜ê³ , ë‚˜ë¨¸ì§€ 400ëª…ì€ ì¬ê³  ì†Œì§„ ë˜ëŠ” ì¤‘ë³µ ë°œê¸‰ìœ¼ë¡œ ê±°ì ˆë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# 1. í…ŒìŠ¤íŠ¸ ì „ ë°ì´í„° ì´ˆê¸°í™”
curl -X POST http://localhost:8080/api/test/reset

# 2. Redis ì¬ê³  ì´ˆê¸°í™”
curl -X POST "http://localhost:8080/api/v1/coupons/stock/init?couponCode=FLASH100&quantity=100"

# 3. k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
k6 run scripts/coupon-load-test.js
```

### ê²°ê³¼ ê²€ì¦

```bash
# Redis ë‚¨ì€ ì¬ê³  í™•ì¸ (0ì´ì–´ì•¼ í•¨)
curl http://localhost:8080/api/v1/coupons/stock/FLASH100

# DB ë°œê¸‰ ì´ë ¥ í™•ì¸ (MySQL ì§ì ‘ ì¡°íšŒ)
docker exec -it htl-mysql-local mysql -u htl_local_user -phtl_local_pw htl_local \
  -e "SELECT COUNT(*) as issued_count FROM coupon_issues WHERE coupon_id = 2;"
# â†’ 100

# ì‹¤íŒ¨ ê¸°ë¡ í™•ì¸
docker exec -it htl-mysql-local mysql -u htl_local_user -phtl_local_pw htl_local \
  -e "SELECT COUNT(*) as failed_count FROM failed_coupon_issues;"
# â†’ 0 (ì •ìƒì´ë©´ ì‹¤íŒ¨ ê¸°ë¡ ì—†ìŒ)
```

<br>

## API ëª…ì„¸

| Method | Endpoint | ì„¤ëª… | í™˜ê²½ |
|:---|:---|:---|:---|
| `POST` | `/api/v1/coupons/issue` | ì¿ í° ë°œê¸‰ ìš”ì²­ | ì „ì²´ |
| `POST` | `/api/v1/coupons/stock/init` | Redis ì¬ê³  ì´ˆê¸°í™” | local |
| `GET` | `/api/v1/coupons/stock/{couponCode}` | í˜„ì¬ Redis ì¬ê³  ì¡°íšŒ | local |
| `POST` | `/api/test/reset` | DB í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™” | local |

### ì¿ í° ë°œê¸‰ ìš”ì²­/ì‘ë‹µ

```json
// Request
POST /api/v1/coupons/issue
{
  "couponCode": "FLASH100",
  "memberId": 1
}

// Response (ì„±ê³µ)
{
  "success": true,
  "data": {
    "couponCode": "FLASH100",
    "memberId": 1,
    "message": "ì¿ í° ë°œê¸‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
  },
  "timestamp": "2025-01-01T12:00:00"
}

// Response (ì¬ê³  ì†Œì§„)
{
  "success": false,
  "error": {
    "code": "COUPON-003",
    "message": "ì¿ í°ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤."
  },
  "timestamp": "2025-01-01T12:00:00"
}
```

<br>

## Docker í™˜ê²½ êµ¬ì„±

### ì»¨í…Œì´ë„ˆ êµ¬ì„±

| ì»¨í…Œì´ë„ˆ | ì´ë¯¸ì§€ | í¬íŠ¸ | ìš©ë„ |
|:---|:---|:---|:---|
| `htl-mysql-local` | mysql:8.0 | 3306 | ë¡œì»¬ ê°œë°œ DB |
| `htl-mysql-prod` | mysql:8.0 | 3307 | ìš´ì˜ ì‹œë®¬ë ˆì´ì…˜ DB |
| `htl-redis` | redis:latest | 6379 | ì¬ê³  ê´€ë¦¬, ì¤‘ë³µ ì²´í¬ |
| `htl-zookeeper` | cp-zookeeper:7.5.0 | 2181 | Kafka ë©”íƒ€ë°ì´í„° ê´€ë¦¬ |
| `htl-kafka` | cp-kafka:7.5.0 | 9092, 29092 | ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° |

### ê°œë°œ ì‹œë‚˜ë¦¬ì˜¤

```bash
# ë¡œì»¬ ê°œë°œ: ì¸í”„ë¼ë§Œ Docker, ì•±ì€ IDEì—ì„œ ì‹¤í–‰
docker-compose up db-local redis zookeeper kafka -d
./gradlew bootRun

# ìš´ì˜ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜: ì „ì²´ Docker
docker-compose up -d
```

<br>

## íšŒê³ ë¡

Phaseë³„ ì§„í–‰ ê³¼ì •ì—ì„œ ì–´ë–¤ ë¬¸ì œë¥¼ ë§Œë‚¬ê³ , ì™œ ê·¸ ê¸°ìˆ ì„ ì„ íƒí–ˆëŠ”ì§€ì— ëŒ€í•œ ìƒì„¸í•œ ê¸°ë¡ì€ íšŒê³ ë¡ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ‘‰ [í”„ë¡œì íŠ¸ íšŒê³ ë¡ ë°”ë¡œê°€ê¸°](íšŒê³ ë¡_ë§í¬)